<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lumen</title>
  <link href="resources/styles/branding.css" rel="stylesheet">
  <link href="resources/styles/homepage.css" rel="stylesheet">
  <link href="resources/styles/universal.css" rel="stylesheet">
  <style>
    .fastlane {
      padding: 12px 0 16px;
      border-top: 1px solid var(--hair);
      display: none;
    }
    .fastlane.open { display: block; }
    .fastlane h1 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .fastlane h2 {
      font-size: 14px;
      font-weight: 400;
      color: var(--muted);
      margin-bottom: 16px;
    }
    .fl-tabs {
      display: flex;
      gap: 4px;
      border-bottom: 1px solid var(--hair);
      margin-bottom: 16px;
      justify-content: center;
    }
    .fl-tab {
      appearance: none;
      background: transparent;
      border: none;
      color: var(--muted);
      padding: 10px 16px;
      cursor: pointer;
      font: 14px/1.2 inherit;
      border-bottom: 2px solid transparent;
    }
    .fl-tab:hover { color: var(--fg); }
    .fl-tab.active {
      color: var(--fg);
      border-bottom-color: var(--acc);
    }
    .fl-content { display: none; }
    .fl-content.active { display: block; }
    .pinned-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }
    .pinned-card {
      border: 1px solid var(--hair);
      padding: 12px;
      cursor: pointer;
      position: relative;
      background: var(--bg);
    }
    .pinned-card:hover {
      border-color: var(--acc);
    }
    .pinned-card-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 6px;
      padding-right: 24px;
    }
    .pinned-card-query {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .pinned-card-meta {
      font-size: 11px;
      color: var(--muted);
    }
    .pinned-card-remove {
      position: absolute;
      top: 8px;
      right: 8px;
      appearance: none;
      background: transparent;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      padding: 2px 4px;
      opacity: 0;
    }
    .pinned-card:hover .pinned-card-remove { opacity: 1; }
    .pinned-card-remove:hover { color: var(--fg); }
    .nodes-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }
    .node-item {
      border: 1px solid var(--hair);
      padding: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    .node-url {
      font-family: ui-monospace, monospace;
      font-size: 13px;
      color: var(--fg);
      word-break: break-all;
    }
    .node-status {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #22c55e;
    }
    .status-dot.offline { background: #ef4444; }
    .node-remove {
      appearance: none;
      background: transparent;
      border: 1px solid var(--hair);
      color: var(--muted);
      padding: 4px 10px;
      cursor: pointer;
      font-size: 12px;
    }
    .node-remove:hover {
      border-color: var(--fg);
      color: var(--fg);
    }
    .settings-group {
      border: 1px solid var(--hair);
      padding: 16px;
      margin-bottom: 12px;
    }
    .settings-group-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--hair);
    }
    .setting-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      gap: 16px;
    }
    .setting-label { font-size: 14px; }
    .setting-desc {
      font-size: 12px;
      color: var(--muted);
      margin-top: 3px;
    }
    .toggle {
      position: relative;
      width: 44px;
      height: 24px;
      background: var(--hair);
      cursor: pointer;
      flex-shrink: 0;
    }
    .toggle.active { background: var(--acc); }
    .toggle::after {
      content: '';
      position: absolute;
      width: 18px;
      height: 18px;
      background: var(--bg);
      top: 3px;
      left: 3px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .toggle.active::after { left: 23px; }
    .empty-state {
      text-align: center;
      padding: 32px 16px;
      color: var(--muted);
    }
    .empty-icon {
      font-size: 32px;
      margin-bottom: 8px;
      opacity: 0.5;
    }
        /* MOTD Banner Styles */
    .motd-container {
      margin-top: 24px;
      width: 100%;
    }

    .motd-banner {
      display: flex;
      gap: 16px;
      padding: 32px;
      text-decoration: none;
      color: var(--fg);
      overflow: hidden;
      width: 100%;
      text-align: start;
    }

    .motd-banner img.motd-image {
      object-fit: contain;
      width: 96px;
      height: 96px;
    }

    .motd-content {
      justify-content: center;
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex-grow: 1;
      min-width: 0; /* Prevents text overflow issues in flexbox */
    }

    .motd-header {
      font-size: 16px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .motd-subtitle {
      font-size: 14px;
      color: var(--muted); /* Use existing theme variable */
      line-height: 1.4;
    }
    
    .motd-header.is-clickable {
      color: var(--acc);
      text-decoration: none;
    }
  </style>
</head>
<body>
  <header id="hdr" class="hdr" style="--hdr-h:72px">
    <div class="hdr-inner">
      <div class="bar">
        <a href="/" aria-label="Lumen home"><img class="logo-img" src="resources/service-icons/mini-mini.png" alt="Lumen"></a>
        <div style="display:flex; gap:8px;">
          <button id="fastlaneBtn" class="icon-btn" aria-label="Fastlane">
            <img class="icon" src="resources/svg/dashboard_24dp_E3E3E3_FILL0_wght400_GRAD0_opsz24.svg">
          </button>
        </div>
      </div>

      <div id="fastlane" class="fastlane" aria-hidden="true">
        <h1>Fastlane</h1>
        
        <div class="fl-tabs">
          <button class="fl-tab active" data-tab="pinned">Pinned</button>
          <button class="fl-tab" data-tab="nodes">Nodes</button>
          <button class="fl-tab" data-tab="settings">Settings</button>
        </div>

        <div id="pinnedTab" class="fl-content active">
          <div id="pinnedGrid" class="pinned-grid"></div>
          <button class="btn" id="addPinnedBtn">+ Add Pinned Search</button>
        </div>

        <div id="nodesTab" class="fl-content">
          <div id="nodesList" class="nodes-list"></div>
          <button class="btn" id="addNodeBtn">+ Add Node</button>
        </div>

        <div id="settingsTab" class="fl-content">
          <div class="settings-group">
            <div class="settings-group-title">Appearance</div>
            <div class="setting-row">
              <div>
                <div class="setting-label">Dark Mode</div>
                <div class="setting-desc">Follows system preference</div>
              </div>
              <div class="toggle active"></div>
            </div>
            <div class="setting-row">
              <div>
                <div class="setting-label">Animated Logos</div>
                <div class="setting-desc">Show animated logo variations</div>
              </div>
              <div class="toggle active" id="toggleLogos"></div>
            </div>
          </div>
          <div class="settings-group">
            <div class="settings-group-title">Search</div>
            <div class="setting-row">
              <div>
                <div class="setting-label">Auto-focus Search</div>
                <div class="setting-desc">Focus search box on load</div>
              </div>
              <div class="toggle active" id="toggleAutofocus"></div>
            </div>
            <div class="setting-row">
              <div>
                <div class="setting-label">Save History</div>
                <div class="setting-desc">Keep track of recent searches</div>
              </div>
              <div class="toggle active" id="toggleHistory"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="logo">
      <span class="i">L</span><span class="rest">umen</span>
    </div>

    <div class="search-table">
      <div class="search-stack" id="searchStack">
        <form class="search" id="homeSearchForm" autocomplete="off">
          <input class="q" id="q" name="q" type="search" placeholder="" autofocus />
        </form>



        <!-- Inline Advanced -->
        <div id="searchAdv" class="search-adv" aria-label="Advanced search">
          <div class="adv-grid">
            <label>
              <span class="lbl">Node</span>
              <input id="advNode" class="flt-input" placeholder="e.g. https://node.example.com" />
              <div id="advNodeStatus" class="hint"></div>
            </label>
            <label>
              <span class="lbl">Method</span>
              <select id="advMethod" class="sel"></select>
            </label>
          </div>
          <div id="advFiltersWrap" style="margin-top:10px;">
            <div style="font-size:12px; color:var(--muted); margin-bottom:6px;">Filters</div>
            <div id="advFilters" class="filters-grid"></div>
          </div>
        </div>
      </div>

      <button id="goBtn" class="bar-search-button" type="button">Go</button>
      <button id="advancedBtn" class="bar-param-button" type="button" style="width:auto; padding:0 10px;">Advanced</button>
    </div>
            <div id="motd-container" class="motd-container"></div>
  </main>
  <footer id="siteFooter" class="site-footer" role="contentinfo" aria-label="Footer">
    <div class="foot-inner">
      <div class="foot-meta">
        <span id="feVersion">Frontend vâ€”</span>
        <span>â€¢</span>
        <span id="nodeVersion">Node â€”</span>
      </div>
      <nav class="foot-links" aria-label="Footer links">
        <a href="https://BrickerFixer.github.io/">News</a>
        <a href="/about.html">About</a>
        <a href="https://github.com/BrickerFixer/Lumen-frontend" target="_blank" rel="noopener noreferrer">Source</a>
      </nav>
    </div>
  </footer>
  

  <script>
    // === DEFAULT NODE CONFIGURATION ===
    const DEFAULT_NODE = "http://localhost:3001"; // â† YOUR NODE

    // Fastlane toggle
    const hdr = document.getElementById('hdr');
    const fastlaneBtn = document.getElementById('fastlaneBtn');
    const fastlane = document.getElementById('fastlane');
    let fastlaneOpen = false;
    function applyHeaderState() {
      hdr.classList.toggle('is-fastlane', fastlaneOpen);
      fastlane.classList.toggle('open', fastlaneOpen);
      fastlane.setAttribute('aria-hidden', String(!fastlaneOpen));
    }
    fastlaneBtn.addEventListener('click', () => { fastlaneOpen = !fastlaneOpen; applyHeaderState(); });
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && fastlaneOpen) { fastlaneOpen = false; applyHeaderState(); } });

    // Logo
    const ASSET_DIR = "resources/logo/";
    let LOGO_ASSETS = ["copycat.html","proc.html","flashlight.html","magnet.html","mondrian.html","pointilism.html","coffee.html","pipes.html","captcha.html","dos.html"].map(x => ASSET_DIR + x);
    const $logo = document.getElementById("logo");
    (async function initAssets() {
      try { const res = await fetch(ASSET_DIR + "manifest.json", { cache: "no-store" });
        if (res.ok) { const json = await res.json(); if (Array.isArray(json.assets) && json.assets.length) LOGO_ASSETS = json.assets.map(x => ASSET_DIR + x); }
      } catch(_) {}
      loadRandomLogo();
    })();
    const isHTML = p => /\.html?$/i.test(p);
    const isImg = p => /\.(png|jpe?g|gif|svg|webp|avif)$/i.test(p);
    function showDefaultLogo(){ $logo.innerHTML = `<div class="logo-text" aria-label="Lumen"><span class="i">I</span><span class="rest">ndex</span></div>`; }
    async function loadRandomLogo(){ if(!LOGO_ASSETS.length) return showDefaultLogo(); await showAsset(LOGO_ASSETS[Math.floor(Math.random()*LOGO_ASSETS.length)]); }
    async function showAsset(url){ const lower=url.toLowerCase();
      if(isHTML(lower)){ $logo.innerHTML=""; const frame=document.createElement("iframe"); frame.src=url; frame.loading="eager"; frame.title="Lumen logo"; $logo.appendChild(frame); }
      else if(isImg(lower)){ $logo.innerHTML=""; const img=new Image(); img.alt="Lumen logo"; img.decoding="async"; img.src=url; $logo.appendChild(img); }
      else showDefaultLogo();
    }
    window.addEventListener("load",()=>{ const q=document.getElementById("q"); if(q) q.focus({preventScroll:true}); });

    // Homepage search + inline Advanced
    const SEARCH_PAGE = '/lumsearch.html';

    const pageUrl = new URL(window.location.href);
    const urlNodeParam = pageUrl.searchParams.get('node');
    const defaultNode = urlNodeParam !== null ? urlNodeParam : DEFAULT_NODE;

    const homeSearchForm = document.getElementById('homeSearchForm');
    const qInput = document.getElementById('q');
    const goBtn = document.getElementById('goBtn');
    const advancedBtn = document.getElementById('advancedBtn');
    const advNode = document.getElementById('advNode');
    const advNodeStatus = document.getElementById('advNodeStatus');
    const advMethod = document.getElementById('advMethod');
    const advFiltersWrap = document.getElementById('advFiltersWrap');
    const advFilters = document.getElementById('advFilters');

    // Random fun placeholder suggestions
    const placeholders = [
      "Weather in New Yorkâ€¦",
      "What is periwinkle...",
      "Why do cats purr...",
      "Best pizza near me...",
      "How fast can a snail go...",
      "Who invented the paperclip...",
      "Time in Tokyo right now...",
      "Is cereal soup...",
      "Can fish sneeze...",
      "Quantum computing for kids...",
      "How to fold a fitted sheet...",
      "Why is the sky blue...",
      "Coffee or tea...",
      "How many stars are in the universe...",
      "What's trending today...",
      "Is AI taking over the world...",
      "Where is the tallest tree...",
      "Recipes with only 3 ingredients...",
      "Meaning of life..."
    ];

    // Assign a random one on page load
    qInput.placeholder = placeholders[Math.floor(Math.random() * placeholders.length)];


    // Pre-fill node input if we have a default and input is empty
    if (defaultNode && !advNode.value) {
      advNode.value = defaultNode;
    }

    let advOpen = false;
    let methods = [];
    let selectedMethod = '';
    let methodCapabilities = {};
    let filterValues = {};
    let metadataFetchId = 0;

    function escapeHtml(s=''){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'<','>':'>','"':'&quot;',"'":'&#39;'}[c])); }
    function prettifyId(id){ return id.replace(/[-_]+/g,' ').replace(/([a-z0-9])([A-Z])/g,'$1 $2').replace(/\s+/g,' ').trim().replace(/\b\w/g,c=>c.toUpperCase()); }
    function getMethodLabel(id){ const caps = methodCapabilities[id] || {}; return caps.displayName || caps.label || caps.name || caps.title || prettifyId(id); }

    function toggleAdvanced() {
      advOpen = !advOpen;
      searchAdv.classList.toggle('open', advOpen);
      searchStack.classList.toggle('adv-open', advOpen);
      advancedBtn.textContent = advOpen ? 'Hide' : 'Advanced';
      if (advOpen && !methods.length) {
        fetchMetadata();
      }
    }
    advancedBtn.addEventListener('click', toggleAdvanced);

    async function fetchMetadata() {
      const fetchId = ++metadataFetchId;
      const node = (advNode.value || '').trim() || defaultNode;
      if (!node) {
        advNodeStatus.textContent = 'Node address is required to load methods.';
        advMethod.innerHTML = '';
        advFilters.innerHTML = '';
        return;
      }

      advNodeStatus.textContent = 'Loading methodsâ€¦';
      try {
        const res = await fetch(node + '/metadata', { method: 'GET' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        if (fetchId !== metadataFetchId) return;
        methods = Array.isArray(data.methods) ? data.methods : [];
        methodCapabilities = data.methodCapabilities || {};
        renderMethodSelect();
        renderFilters();
        advNodeStatus.textContent = '';
      } catch (e) {
        if (fetchId !== metadataFetchId) return;
        advNodeStatus.textContent = 'Failed to load metadata from node.';
        advMethod.innerHTML = '';
        advFilters.innerHTML = '';
      }
    }

    function renderMethodSelect() {
      const current = selectedMethod;
      advMethod.innerHTML = methods.map(m => `<option value="${escapeHtml(m)}">${escapeHtml(getMethodLabel(m))}</option>`).join('');
      if (current && methods.includes(current)) {
        advMethod.value = current;
      } else {
        selectedMethod = methods[0] || '';
        advMethod.value = selectedMethod;
      }
      advMethod.disabled = !methods.length;
    }

    function renderFilters() {
      advFilters.innerHTML = '';
      const caps = methodCapabilities[selectedMethod] || {};
      const flts = Array.isArray(caps.filters) ? caps.filters : [];
      advFiltersWrap.style.display = flts.length ? 'block' : 'none';
      flts.forEach(f => {
        const wrap = document.createElement('label');
        wrap.innerHTML = `<span class="lbl">${escapeHtml(f.name)}</span>`;
        let input;
        if (Array.isArray(f.choices)) {
          input = document.createElement('select'); input.className = 'sel';
          f.choices.forEach(choice => {
            const opt = document.createElement('option'); opt.value = choice; opt.textContent = choice; input.appendChild(opt);
          });
          input.value = (filterValues[f.name] !== undefined) ? filterValues[f.name] : (f.default ?? f.choices[0] ?? '');
        } else {
          input = document.createElement('input'); input.className = 'flt-input'; input.type = 'text';
          input.value = (filterValues[f.name] !== undefined) ? filterValues[f.name] : (f.default ?? '');
        }
        input.onchange = () => { filterValues[f.name] = input.value; };
        wrap.appendChild(input);
        advFilters.appendChild(wrap);
      });
    }

    advNode.addEventListener('change', () => { 
      methods = []; 
      methodCapabilities = {}; 
      selectedMethod = ''; 
      filterValues = {}; 
      fetchMetadata(); 
    });
    advMethod.addEventListener('change', () => { selectedMethod = advMethod.value; renderFilters(); });

    function buildSearchUrl() {
      const q = (qInput.value || '').trim();
      const node = (advNode.value || '').trim() || defaultNode;

      if (!node) {
        throw new Error('Node is required');
      }

      const url = new URL(SEARCH_PAGE, window.location.origin);
      if (q) url.searchParams.set('q', q);
      url.searchParams.set('node', node);

      const caps = methodCapabilities[selectedMethod] || {};
      const flts = Array.isArray(caps.filters) ? caps.filters : [];
      flts.forEach(f => {
        const v = (filterValues[f.name] !== undefined) ? String(filterValues[f.name]).trim() : '';
        if (v) url.searchParams.set(f.name, v);
      });
      return url.toString();
    }

    function doSearchRedirect() {
      const node = (advNode.value || '').trim() || defaultNode;
      if (!node) {
        advNodeStatus.textContent = 'Node address is required.';
        advNode.focus();
        return;
      }
      try {
        window.location.href = buildSearchUrl();
      } catch (e) {
        advNodeStatus.textContent = 'Node address is required.';
        advNode.focus();
      }
    }

    homeSearchForm.addEventListener('submit', (e) => { e.preventDefault(); doSearchRedirect(); });
    goBtn.addEventListener('click', doSearchRedirect);
  </script>
  <script>
(function() {
  const DEFAULT_NODE = "http://localhost:3001"; // â† same as above

  const feSpan = document.getElementById('feVersion');
  const nodeSpan = document.getElementById('nodeVersion');

  const feMeta = document.querySelector('meta[name="app:version"]');
  const FRONTEND_VERSION = (window.__FRONTEND_VERSION__ || (feMeta && feMeta.content) || 'dev').trim();
  feSpan.textContent = `Frontend v${FRONTEND_VERSION}`;

  function getUrlNode() {
    try {
      const u = new URL(window.location.href);
      return u.searchParams.get('node');
    } catch {
      return null;
    }
  }

  async function fetchNodeInfo(nodeBase) {
    const info = { name: '', version: '' };

    async function getJSON(url, ms = 2500) {
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), ms);
      try {
        const res = await fetch(url, { signal: ctrl.signal });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return await res.json();
      } finally {
        clearTimeout(t);
      }
    }

    try {
      const meta = await getJSON(nodeBase + '/metadata');
      info.name = meta?.name || '';
      info.version = meta?.version || meta?.nodeVersion || '';
    } catch {}

    if (!info.version) {
      try {
        const health = await getJSON(nodeBase + '/health');
        info.version = health?.version || health?.nodeVersion || '';
      } catch {}
    }

    if (!info.name) {
      try { info.name = new URL(nodeBase).host; } catch { info.name = nodeBase; }
    }
    return info;
  }

  async function updateNodeFooter(nodeBase) {
    if (!nodeBase) {
      nodeSpan.textContent = 'Node: not specified';
      return;
    }
    try {
      const info = await fetchNodeInfo(nodeBase);
      const verText = info.version ? ` v${info.version}` : '';
      nodeSpan.textContent = `Node: ${info.name}${verText}`;
    } catch {
      nodeSpan.textContent = 'Node: offline';
    }
  }

  const initialNode = getUrlNode() || DEFAULT_NODE;
  updateNodeFooter(initialNode);

  const advNode = document.getElementById('advNode');
  if (advNode) {
    advNode.addEventListener('change', () => {
      const val = advNode.value.trim();
      const nextNode = val || getUrlNode() || DEFAULT_NODE;
      updateNodeFooter(nextNode);
    });
  }
})();
</script>
  <script>
    const state = {
      pinned: JSON.parse(localStorage.getItem('lumen_pinned') || '[]'),
      nodes: JSON.parse(localStorage.getItem('lumen_nodes') || '[{"url":"http://localhost:3001","active":true}]')
    };

    function save() {
      localStorage.setItem('lumen_pinned', JSON.stringify(state.pinned));
      localStorage.setItem('lumen_nodes', JSON.stringify(state.nodes));
    }

    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && fastlaneOpen) {
        fastlaneOpen = false;
        fastlane.classList.remove('open');
        hdr.classList.remove('is-fastlane');
        fastlane.setAttribute('aria-hidden', 'true');
      }
    });

    document.querySelectorAll('.fl-tab').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.fl-tab').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.fl-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab + 'Tab').classList.add('active');
      });
    });

    function renderPinned() {
      const grid = document.getElementById('pinnedGrid');
      if (state.pinned.length === 0) {
        grid.innerHTML = '<div class="empty-state"><div class="empty-icon">ðŸ“Œ</div><div>No pinned searches yet</div></div>';
        return;
      }
      grid.innerHTML = state.pinned.map((pin, i) => `
        <div class="pinned-card" onclick="window.location.href='/lumsearch.html?q=${encodeURIComponent(pin.query)}&node=${encodeURIComponent(pin.node)}'">
          <button class="pinned-card-remove" onclick="event.stopPropagation(); removePinned(${i})">Ã—</button>
          <div class="pinned-card-title">${escapeHtml(pin.title || pin.query)}</div>
          <div class="pinned-card-query">${escapeHtml(pin.query)}</div>
          <div class="pinned-card-meta">Pinned ${new Date(pin.date).toLocaleDateString()}</div>
        </div>
      `).join('');
    }

    function renderNodes() {
      const list = document.getElementById('nodesList');
      if (state.nodes.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="empty-icon">ðŸ”Œ</div><div>No nodes configured</div></div>';
        return;
      }
      list.innerHTML = state.nodes.map((node, i) => `
        <div class="node-item">
          <div style="flex:1; min-width:0">
            <div class="node-url">${escapeHtml(node.url)}</div>
            <div class="node-status">
              <div class="status-dot ${node.active ? '' : 'offline'}"></div>
              ${node.active ? 'Active' : 'Inactive'}
            </div>
          </div>
          <button class="node-remove" onclick="removeNode(${i})">Remove</button>
        </div>
      `).join('');
    }

    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    window.removePinned = (i) => {
      state.pinned.splice(i, 1);
      save();
      renderPinned();
    };

    window.removeNode = (i) => {
      if (state.nodes.length === 1) {
        alert('You must have at least one node');
        return;
      }
      state.nodes.splice(i, 1);
      save();
      renderNodes();
    };

    document.getElementById('addPinnedBtn').addEventListener('click', () => {
      const query = prompt('Enter search query:');
      if (query && query.trim()) {
        state.pinned.push({
          query: query.trim(),
          title: query.trim(),
          node: state.nodes[0]?.url || 'http://localhost:3001',
          date: Date.now()
        });
        save();
        renderPinned();
      }
    });

    document.getElementById('addNodeBtn').addEventListener('click', () => {
      const url = prompt('Enter node URL:');
      if (url && url.trim()) {
        state.nodes.push({ url: url.trim(), active: true });
        save();
        renderNodes();
      }
    });

    document.querySelectorAll('.toggle').forEach(toggle => {
      toggle.addEventListener('click', () => {
        toggle.classList.toggle('active');
      });
    });

    document.getElementById('goBtn').addEventListener('click', () => {
      const q = document.getElementById('q').value.trim();
      if (q) {
        window.location.href = `/lumsearch.html?q=${encodeURIComponent(q)}&node=${encodeURIComponent(state.nodes[0]?.url || 'http://localhost:3001')}`;
      }
    });

    renderPinned();
    renderNodes();
  </script>
    <script>
    (function() {
      // This IIFE (Immediately Invoked Function Expression) keeps the scope clean.
      document.addEventListener('DOMContentLoaded', () => {
        const motdContainer = document.getElementById('motd-container');
        if (!motdContainer) return;

        // Use the same logic as other scripts to determine the current node.
        const pageUrl = new URL(window.location.href);
        const urlNodeParam = pageUrl.searchParams.get('node');
        const currentNode = urlNodeParam || window.DEFAULT_NODE || 'http://localhost:3001';

        async function fetchAndRenderMOTD() {
          try {
            const response = await fetch(`${currentNode}/motd`);
            if (!response.ok) {
              throw new Error(`MOTD endpoint failed with status ${response.status}`);
            }

            const data = await response.json();

            // Don't render anything if there's no message content.
            if (!data.header && !data.subtitle) {
              return;
            }

            // Create the main banner element. If there's a link, it's an <a> tag.
            const isClickable = !!data.header_link;
            const banner = document.createElement('div');
            banner.className = 'motd-banner';


            // 1. Create and add the Image (if it exists)
            if (data.image) {
              const imageUrl = new URL(data.image, currentNode).href;
              const img = document.createElement('img');
              img.src = imageUrl;
              img.alt = data.header || 'MOTD Image';
              img.className = 'motd-image';
              banner.appendChild(img);
            }

            // 2. Create the content container for text
            const contentDiv = document.createElement('div');
            contentDiv.className = 'motd-content';

            // 3. Create and add the Header (if it exists)
            if (data.header) {
              const headerDiv = document.createElement(isClickable ? 'a' : 'div');
              headerDiv.className = 'motd-header';
              headerDiv.textContent = data.header;
              contentDiv.appendChild(headerDiv);
              if (isClickable) {
                headerDiv.classList.add('is-clickable');
                headerDiv.href = data.header_link;
                headerDiv.target = '_blank'; // Open in a new tab
                headerDiv.rel = 'noopener noreferrer';
              }
            }

            // 4. Create and add the Subtitle (if it exists)
            if (data.subtitle) {
              const subtitleDiv = document.createElement('div');
              subtitleDiv.className = 'motd-subtitle';
              subtitleDiv.textContent = data.subtitle;
              contentDiv.appendChild(subtitleDiv);
            }
            
            banner.appendChild(contentDiv);
            
            // Clear the container and inject the new banner
            motdContainer.innerHTML = '';
            motdContainer.appendChild(banner);

          } catch (error) {
            console.error('Could not fetch or render MOTD:', error);
            // Do nothing on the UI, the banner will simply not appear.
          }
        }

        fetchAndRenderMOTD();
      });
    })();
  </script>
</body>
</html>